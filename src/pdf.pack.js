/**
 * @description 对pdf.js的封装，使用更方便，不需要关注内部细节（包含高清屏适配）
 * @author liww
 * @return {Function} window.PDF(pdfUrl, container, options)
 */

(function () {

  // PDFJS.workerSrc = 'src/plugins/pdf.worker.js';

  // 获取屏幕 物理像素 / 设备独立像素dip 比例
  var PIXEL_RATIO = (function () {
    var ctx = document.createElement("canvas").getContext("2d"),
      dpr = window.devicePixelRatio || 1,
      bsr = ctx.webkitBackingStorePixelRatio ||
        ctx.mozBackingStorePixelRatio ||
        ctx.msBackingStorePixelRatio ||
        ctx.oBackingStorePixelRatio ||
        ctx.backingStorePixelRatio || 1;

    return dpr / bsr;
  })();

  var loadingStyle = '.pdf-loading {position: relative;}' +
    '.pdf-loading:before {' +
    'background-image: url(data:img/jpg;base64,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);' +
    'background-repeat: no-repeat;' +
    'background-position: center;' +
    'background-color: rgba(255, 255, 255, 0.4);' +
    'position: absolute;' +
    'top: 0;' +
    'left: 0;' +
    'z-index: 2;' +
    'width: 100%;' +
    'height: 100%;' +
    'content: " ";' +
    '}';

  /**
   * @param pdfUrl {String} pdf的地址
   * @param container {String} 显示pdf的容器id
   * @param options {Object}
   *      - scale {Number} 默认值：1
   *      - width {Number} 默认值：'auto'
   *      - numPages {Number} 默认值：'auto'
   *      - canvasClass {String}
   *      - canvasWrap {String} 默认值：'div'
   *      - canvasWrapClass {String}
   *      - loadBefore {Function} 加载之前执行
   *      - renderAfter {Function} 渲染完成后执行
   */
  window.PDF = function(pdfUrl, container, options) {
    var cfg = {
      scale: 1,
      width: 'auto',
      numPages: 'auto',
      canvasClass: '',
      canvasWrap: 'div',
      canvasWrapClass: '',
      loadBefore: null,
      renderAfter: null
    };
    for (var name in options) {
      if (cfg.hasOwnProperty(name)) {
        cfg[name] = options[name];
      }
    }

    // 插入loading样式
    var styleEl = document.createElement('style');
    styleEl.innerHTML = loadingStyle;
    document.head.appendChild(styleEl);

    // 异地加载pdf文件
    var loadingTask = PDFJS.getDocument(pdfUrl);

    if (typeof cfg.loadBefore === 'function') {
      cfg.loadBefore();
    }
    loadingTask.promise.then(function(pdf) {

      var numPages = (typeof cfg.numPages === 'number') ? cfg.numPages : pdf.numPages;
      for (var i = 0; i < numPages; i++) {
        pdf.getPage(i + 1).then(function(page) {
          // 设置文档显示比例，width 优先级高于 scale
          var scale = cfg.scale;
          if (cfg.width > 0) {
            scale = cfg.width / page.getViewport(1).width;
          }
          var viewport = page.getViewport(scale);

          var canvasWrap = document.createElement(cfg.canvasWrap);
          var canvas = document.createElement('canvas');
          var context = canvas.getContext('2d');

          canvas.className = cfg.canvasClass;
          canvasWrap.className = 'pdf-loading' + ' ' + cfg.canvasWrapClass;

          // 适配高清屏
          canvas.height = viewport.height * PIXEL_RATIO;
          canvas.width = viewport.width * PIXEL_RATIO;
          canvas.style.width = viewport.width + 'px';
          canvas.style.height = viewport.height + 'px';
          canvasWrap.style.width = canvas.style.width;
          // canvasWrap.style.height = canvas.style.height;
          context.setTransform(PIXEL_RATIO, 0, 0, PIXEL_RATIO, 0, 0);

          document.getElementById(container).appendChild(canvasWrap);
          canvasWrap.appendChild(canvas);

          // Render PDF page into canvas context
          var renderContext = {
            canvasContext: context,
            viewport: viewport
          };
          var renderTask = page.render(renderContext);
          renderTask.then(function () {
            canvasWrap.className = cfg.canvasWrapClass;
            // console.log('Page rendered');
            if (typeof cfg.renderAfter === 'function') {
              cfg.renderAfter();
            }
          });
        });
      }
    }, function (reason) {
      // PDF loading error
      console.error(reason);
    });
  }

}());